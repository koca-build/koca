name: Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: false

      - name: Install yq
        run: sudo snap install yq

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check version tag
        id: tag_check
        run: |
          VERSION="$(yq -r '.workspace.package.version' Cargo.toml)"
          if [[ -z "$VERSION" ]]; then
            echo "Failed to parse workspace version from Cargo.toml"
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          TAG="v${VERSION}"

          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "release_tag=${TAG}" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "release_tag=${TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build .deb package
        if: steps.tag_check.outputs.tag_exists == 'false'
        run: cargo run --locked --bin koca -- create koca.koca --output-type deb

      - name: Build .rpm package
        if: steps.tag_check.outputs.tag_exists == 'false'
        run: cargo run --locked --bin koca -- create koca.koca --output-type rpm

      - name: Collect package artifacts
        if: steps.tag_check.outputs.tag_exists == 'false'
        run: |
          mkdir -p dist
          shopt -s nullglob
          for pkg in ./*.deb ./*.rpm; do
            mv "$pkg" dist/
          done
          ls -lh dist

      - name: Upload workflow artifacts
        if: steps.tag_check.outputs.tag_exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: koca-packages
          path: dist/*
          if-no-files-found: error

      - name: Upload release assets
        if: steps.tag_check.outputs.tag_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.tag_check.outputs.version }}
          tag_name: ${{ steps.tag_check.outputs.release_tag }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: dist/*
          fail_on_unmatched_files: true
